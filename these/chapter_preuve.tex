
\chapter{Preuve de correction}
\label{sec:preuve-correction}

%\chapterintro

TODO

The grammar of E-ACSL \cite{E-ACSL} terms and predicates allowed in annotations
is detailed in Sec.~\ref{sec:grammar}.
The properties we are trying to establish in this paper are expressed
in Sec.~\ref{sec:properties}.
Sections~\ref{sec:term-translation}, \ref{sec:predicate-translation} and
\ref{sec:annotation-translation} contain the proofs of these properties,
respectively on terms, on predicates and on annotations.


\section{Grammar of input language}
\label{sec:grammar}

%\begin{figure}
\begin{tabular}{lrl}
  \textit{term} & ::= & \textit{cst} \\
  & $\mid$ & \textit{lvalue} \\
  & $\mid$ & $-$ \textit{term} \\
  & $\mid$ & $*$ \textit{term} \\
  & $\mid$ & $!$ \textit{term} \\
  & $\mid$ & $~$ \textit{term} \\
  & $\mid$ & \textit{term} \textit{binop} \textit{term} \\
  & $\mid$ & \lstinline'\abs(' \textit{term} \lstinline')' \\
  & $\mid$ & \lstinline'\sum(' \textit{term}$,$ \textit{term}$,$
  \lstinline'\lambda integer' \textit{id}$;$ \textit{term} \lstinline')' \\
  & $\mid$ & \lstinline'\product(' \textit{term}, \textit{term},
  \lstinline'\lambda integer' \textit{id}; \textit{term} \lstinline')' \\
  & $\mid$ & \lstinline'\numof(' \textit{term}, \textit{term},
  \lstinline'\lambda integer' \textit{id}; \textit{term} \lstinline')' \\
  & $\mid$ & \textit{term} \texttt{?} \textit{term} \texttt{:} \textit{term} \\
  & $\mid$ & \lstinline'\old(' \textit{term} \lstinline')' \\
  & $\mid$ & \lstinline'\null' \\
  & $\mid$ & \lstinline'(' \textit{type} \lstinline')' \textit{term} \\
  \textit{pred} & ::= & \lstinline'\true' \\
  & $\mid$ & \lstinline'\false' \\
  & $\mid$ & \lstinline'\valid(' \textit{term} \lstinline')' \\
  & $\mid$ & \lstinline'\forall integer' \textit{id};
  \textit{pred} \lstinline'==>' \textit{pred} \\
  & $\mid$ & \lstinline'\exists integer' \textit{id};
  \textit{pred} \lstinline'&&' \textit{pred} \\
  & $\mid$ & ! \textit{pred} \\
  & $\mid$ & \textit{pred} \lstinline'&&' \textit{pred} \\
  & $\mid$ & \textit{pred} \lstinline'||' \textit{pred} \\
  & $\mid$ & \textit{pred} \lstinline'==>' \textit{pred} \\
  & $\mid$ & \textit{pred} \lstinline'<==>' \textit{pred} \\
  & $\mid$ & \textit{term} ? \textit{pred} : \textit{pred} \\
  & $\mid$ & \textit{term} \textit{relation} \textit{term} \\
  \textit{annot} & ::= & \lstinline'assert' \textit{pred} \\
  & $\mid$ & \lstinline'requires' \textit{pred} \\
  & $\mid$ & \lstinline'typically' \textit{pred} \\
  & $\mid$ & \lstinline'ensures' \textit{pred} \\
  & $\mid$ & \lstinline'loop invariant' \textit{pred} \\
  & $\mid$ & \lstinline'loop variant' \textit{term}
\end{tabular}
%\end{figure}


\section{Semantics of Instructions}
\label{sec:semantics}


\begin{notation}
  ~
  \begin{itemize}
  \item \eval{$t$}{sto} is the evaluation of $t$ in the environment $sto$
  \item \comp{$\Gamma$}{sto} computes a new environment by executing the
    $\Gamma$ instructions from $sto$
  \item $update(sto, var, val)$ is the environment containing the same
    bindings (variable, value) as $sto$, with the extra binding ($var$, $val$)
  \item $undef$ is a special value that is used as uninitialized or freed value
    in bindings
  \item an underlined instruction \underline{\lstinline{instr}} means that the
    unbounded arithmetics is used
  \item $\Zinit$\underline{\lstinline{v}} means that the integer variable
    \lstinline'v' is allocated and ready for use
  \item \underline{\lstinline{v}}$\Zclear$ means that the integer variable
    \lstinline'v' is freed
  \end{itemize}
\end{notation}


\begin{tabular}{rclr}
  \comp{A $\cdot$ B}{sto} &=& \comp{B}{(\comp{A}{sto})} & C-0\\
  \comp{$\Zinit$ \underline{\lstinline|a = b|} $\semicolon$}{sto}
  &=& update(sto, a, \eval{b}{sto}) & C-1\\
  \comp{\underline{\lstinline|a|} $\Zclear \semicolon$}{sto}
  &=& update(sto, a, undef) & C-2\\
  \comp{\lstinline|a = b;|}{sto}
  &=& updataSto(sto, a, \eval{b}{sto}) & C-3\\
  \comp{\lstinline|if(x) A else B|}{sto}
  &=& \comp{A}{sto} \text{ when \eval{x}{sto} = true} & C-4\\
  &=& \comp{B}{sto} \text{ when \eval{x}{sto} = false} & C-5\\
  \comp{\lstinline|while(x) A|}{sto}
  &=& \comp{\lstinline|while(x) A|}{(\comp{A}{sto})}
  \text{ when \eval{x}{sto} = true} & C-6\\
  &=& sto \text{ when \eval{x}{sto} = false} & C-7\\
\end{tabular}

\begin{tabular}{rclr}
  \eval{cst}{sto} &=& cst & E-0\\
  \eval{x}{update(sto, x, y)} &=& \eval{y}{sto} & E-1\\
  \eval{x}{update(sto, a, b)} &=& \eval{x}{sto} & E-2\\
  \eval{\lstinline|x op y|}{sto} &=& \eval{\lstinline|x|}{sto}~\lstinline|op|~\eval{\lstinline|y|}{sto} & E-3\\
\end{tabular}


\section{Properties}
\label{sec:properties}

\begin{notation}
  Let $a$ be an \textsc{ACSL} annotation, such as \lstinline{assert p},
  \lstinline{requires p}, \lstinline{ensures p}, \lstinline{loop invariant p}
  where $p$ is a predicate, or \lstinline{loop variant t} where $t$ is a term.
  Let $A$ be a set of annotations.
  Let $P$ be a syntactically correct C program containing \textsc{ACSL}
  annotations.
  Let $P'$ be the instrumented program obtained after translation of the
  annotations $A$ of the program $P$.
\end{notation}



\begin{theorem}%{Invalid annotations trigger errors in generated code}
  If $a$ is invalid, then the execution of the instruction obtained from the
  translation of $a$ will trigger an error.
\end{theorem}

\begin{theorem}%{The program has the same semantics if all annotations are valid}
  If all annotations $A$ of a program are valid, the instrumented program $P'$
  has the same semantics as $P$ and their executions do not differ.
\end{theorem}



\section{Term translation}
\label{sec:term-translation}


\begin{notation}
  ~
  \begin{itemize}
  \item \openpar \lstinline'instr;' \closepar{i_n} means that this instruction
    is labeled $i_n$
  \item $sto_{i_n}$ denotes the environement obtained after computation of the
    instruction labeled $i_n$ (\comp{$i_n$}{sto} = $sto_{i_n}$)
  \end{itemize}
\end{notation}


\begin{lemma}
  Let $t$ be a term that is translated into $(\Gamma, t')$ by the
  instrumentation. This translation is correct if and only if $\forall$
  environment $sto$:

  \eval{$t'$}{\comp{$\Gamma$}{sto}} = \eval{$t$}{sto}.
\end{lemma}


\subsection{Constant Term}

{\myinference[CST]
  {}
  { (cst : \mathbb{Z}) \mapsto \Zinit\underline{\mathtt{var = cst}}, var }
}

\begin{proof}
  \begin{tabular}{rclr}
    \comp{$\Zinit$\underline{\lstinline|var = cst|}}{sto}
    &$\eq{def}$& update(sto, var, \eval{cst}{sto}) & 1\\
    \eval{var}{\comp{$\Zinit$\underline{\lstinline|var = cst|}}{sto}} \\
    &$\eq{(1)}$ & \eval{var}{update(sto, var, \eval{cst}{sto})} & \\
    &$\eq{def}$ & \eval{cst}{sto} &
  \end{tabular}
\end{proof}


\section{Predicate translation}
\label{sec:predicate-translation}


\begin{lemma}
  Let $p$ be a terpredicate that is translated into $(\Gamma, p')$ by the
  instrumentation. This translation is correct if and only if $\forall$
  environment $sto$:

  \eval{$p'$}{\comp{$\Gamma$}{sto}} = \eval{$p$}{sto}.
\end{lemma}


\subsection{And Predicate}

{\myinference[AND]
  { p_1 \mapsto \Gamma_1, e_1 \& p_2 \mapsto \Gamma_2, e_2 }
  { \mathtt|p_1\ \&\&\ p_2| \mapsto \Gamma, var }
}~\\

where
\(
\Gamma = \Gamma_1
\cdot \openpar \mathtt|int var = e_1;| \closepar{i_1}
\cdot \openpar \mathtt|if(var)| \bopen
\Gamma_2
\cdot \openpar \mathtt|var = e_2;| \closepar{i_3}
\bclose \closepar{i_2}
\)

\begin{proof}
  \begin{tabular}{rclr}
    \comp{$\Gamma_1$}{sto}
    &$\eq{hyp}$& update(sto, $e_1$, \eval{$p_1$}{sto}) = sto$_{e_1}$ & 1\\
    \comp{$i_1$}{sto$_{e_1}$}
    &$\eq{def}$& update(sto$_{i_1}$, var, \eval{$e_1$}{sto$_{e_1}$})&\\
    &$\eq{(1)}$& update(sto$_{i_1}$, var, \eval{$p_1$}{sto}) = sto$_{i_2}$ & 3\\
    \comp{$\Gamma_2$}{sto$_{i_1}$}
    &$\eq{hyp}$& update(sto$_{i_2}$, $e_2$, \eval{$p_2$}{sto}) = sto$_{e_2}$ & 2\\
    \comp{$i_3$}{sto$_{e_2}$}
    &$\eq{def}$& update(sto$_{e_2}$, var, \eval{$e_2$}{sto$_{e_2}$})&\\
    &$\eq{(2)}$& update(sto$_{e_2}$, var, \eval{$p_2$}{sto}) = sto$_{i_3}$ & 5\\
    \eval{var}{sto$_{i_2}$} &$\eq{(3)}$ \eval{$p_1$}{sto}&\\
    \comp{$i_2$}{sto$_{i_1}$}
    &$\eq{def}$& sto$_{i_3}$ \text{if}\ \eval{$p_1$}{sto} = true,
    sto$_{i_1}$ \text{otherwise}
    &4\\
    when \eval{$p_1$}{sto} = true: &6\\
    \eval{var}{\comp{$\Gamma$}{sto}}
    &$\eq{(4)}$& \eval{var}{sto$_{i_3}$} $\eq{(5)}$ \eval{$p_2$}{sto}&\\
    &$\eq{(6)}$& \eval{$p_1$}{sto} $\land$ \eval{$p_2$}{sto}
    $\eq{def}$ \eval{$p_1 \&\& p_2$}{sto}\\
    when \eval{$p_1$}{sto} = false: &7&\\
    \eval{var}{\comp{$\Gamma$}{sto}}
    &$\eq{(4)}$& \eval{var}{sto$_{i_1}$} $\eq{(3)}$ \eval{$p_1$}{sto}&\\
    &$\eq{(7)}$& \eval{$p_1$}{sto} $\land$ \eval{$p_2$}{sto}&\\
    &$\eq{def}$& \eval{$p_1 \&\& p_2$}{sto}&
  \end{tabular}
\end{proof}


\subsection{Forall Predicate}

{\myinference[FORALL]
  {
    (t_1 : \mathbb{Z}) \mapsto \Gamma_1, e_1 \\
    (t_2 : \mathbb{Z}) \mapsto \Gamma_2, e_2 \\
    p \mapsto \Gamma_3, e
  }
  { \mathtt|\backslash forall integer id; t_1 <= id < t_2 ==> p| \mapsto \Gamma, var }
}~\\


where
\begin{tabular}{rclr}
  $\Gamma$ &=& $\Gamma_1$ $\cdot$ $\Gamma_2$
  $\cdot$ \openpar \lstinline|int var = 1;| \closepar{i_1}
  $\cdot$ \openpar $\Zinit$ \underline{\lstinline|id = e_1|} $\semicolon$
  \closepar{i_2}&\\
  && $\cdot$ \openpar \lstinline|while(|
  \underline{\lstinline|id < e_2|}~ \lstinline|&& var)|
  $\bopen$
  $\Gamma_3$
  $\cdot$ \openpar \lstinline|var = e;| \closepar{i_4}
  $\cdot$ \openpar \underline{\lstinline|id++|} $\semicolon$ \closepar{i_5}
  $\bclose$
  \closepar{i_3}&\\
  && $\cdot$ \openpar \underline{\lstinline|id|} $\Zclear$ $\semicolon$ \closepar{i_6}
  $\cdot$ \openpar \underline{\lstinline|e_1|}$\Zclear$ $\semicolon$ \closepar{i_7}
  $\cdot$ \openpar \underline{\lstinline|e_2|}$\Zclear$ $\semicolon$ \closepar{i_8}&
\end{tabular}


\begin{proof}
  \begin{tabular}{rclr}
    \comp{$\Gamma_1$}{sto}
    &=& update(sto, $e_1$, \eval{$t_1$}{sto}) = sto$_{e_1}$ &\\
    \comp{$\Gamma_2$}{sto$_{e_1}$}
    &=& update(sto$_{e_1}$, $e_2$, \eval{$t_2$}{sto}) = sto$_{e_2}$ &\\
    \comp{$i_1$}{sto$_{e_2}$} &=& update(sto$_{e_2}$, var, 1) = sto$_{i_1}$ &\\
    \comp{$i_2$}{sto$_{i_1}$} &=& update(sto$_{i_1}$, id, \eval{$e_1$}{sto$_{i_1}$})&\\
    &=& update(sto$_{i_1}$, id, \eval{$t_1$}{sto}) = sto$_{i_2}$ &\\
    \eval{$var$}{sto$_{i_3}$}
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < t_2 ==> p'}{sto}
    & (Lemma 4.2) \\
    \comp{$i_6$}{sto$_{i_3}$} &=& update(sto$_{i_3}$, id, undef) = sto$_{i_6}$ &\\
    \comp{$i_7$}{sto$_{i_6}$} &=& update(sto$_{i_6}$, $e_1$, undef) = sto$_{i_7}$ &\\
    \comp{$i_8$}{i$_7$} &=& update(sto$_{i_7}$, $e_2$, undef) = sto$_{i_8}$ &\\
    \eval{$var$}{\comp{$\Gamma$}{sto}} &=& \eval{$var$}{sto$_{i_3}$} &\\
    &=& \eval{\lstinline'\\forall integer id; t_1 <= id < t2 ==> p'}{sto} &
  \end{tabular}
\end{proof}



\begin{lemma}
  \eval{$var$}{sto$_{i_3}$}
  = \eval{\lstinline{\\forall integer i; t_1 <= i < t_2 ==> p}}{sto}
\end{lemma}

\begin{proof}
  \begin{tabular}{rclr}
    \text{Suppose the induction hypothesis H}:&&& \\
    \eval{$var$}{sto'}
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < id ==> p'}{sto'} &(H) \\
    \comp{$\Gamma_3$}{sto'} &=& update(sto', e, \eval{$p$}{sto'}) = sto$_e$& \\
    \comp{$i_4$}{sto$_e$} &=& update(sto$_e$, var, \eval{$e$}{sto$_e$}) &\\
    &=& update(sto$_e$, var, \eval{$p$}{sto'}) = sto$_{i_4}$ &\\
    \eval{$var$}{sto$_{i_4}$} &=& \eval{$var$}{sto'} $\land$ \eval{$var$}{sto$_{i_4}$} &\\
    & &the loop condition is true, so \eval{$var$}{sto'} is true as well&\\
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < id ==> p'}{sto'} $\land$ \eval{$p$}{sto'} &\\
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < id ==> p'}{sto'}& \\
    & & $\land$ \eval{\lstinline'\\forall integer i; i = id ==> p'}{sto'} &\\
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i <= id ==> p'}{sto'} &\\
    \comp{$i_5$}{sto$_{i_4}$}
    &=& update(sto$_{i_4}$, id, \eval{$id$}{sto$_{i_4}$} + 1) = sto$_{i_5}$& \\
    \eval{$var$}{sto$_{i_5}$}
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < id ==> p'}{sto'} &\\
    & & because \eval{$id$}{sto$_{i_5}$} = \eval{$id$}{sto$_{i_4}$} + 1 & \\
    & & so (H) is maintained after each iteration of the loop & \\
    \eval{$var$}{sto$_{i_3}$} &=& \eval{\lstinline'\\forall integer i; t_1 <= i < id ==> p'}{sto'} &\\
    \eval{$t_1 \le id \le t_2$}{sto$_{i_3}$} &=& 1 & Lemma 4.3 \\
    \eval{\underline{id < $e_2$}\lstinline' \&\& var'}{sto$_{i_3}$} &=& 0 & \\
    \eval{$id$}{sto$_{i_3}$} < \eval{$e_2$}{sto$_{i_3}$} $\land$ \eval{$var$}{sto$_{i_3}$}
    &=& 0 &\\
    If \eval{$id$}{sto$_{i_3}$} < \eval{$e_2$}{sto$_{i_3}$} = 0:&&& \\
    \eval{$id$}{sto$_{i_3}$} $\ge$ \eval{$e_2$}{sto$_{i_3}$} &=& 1 &\\
    \eval{$id$}{sto$_{i_3}$} $\ge$ \eval{$t_2$}{sto} &=& 1& \\
    \eval{$id$}{sto$_{i_3}$} &=& \eval{$t_2$}{sto} & thanks to Lemma 4.3 \\
    \eval{$var$}{sto$_{i_3}$}
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < t_2 ==> p'}{sto} &\\
    If \eval{$var$}{sto$_{i_3}$} = 0:&&& \\
    \eval{\lstinline'\\forall integer i; t_1 <= i < id ==> p'}{sto'} &=& 0& \\
    \eval{\lstinline'\\forall integer i; t_1 <= i < t_2 ==> p'}{sto'} &=& 0 & thanks to Lemma 4.3 \\
    \eval{\lstinline'\\forall integer i; t_1 <= i < t_2 ==> p'}{sto}
    &=& \eval{$var$}{sto$_{i_3}$} &\\
    So we have: \eval{$var$}{sto$_{i_3}$}
    &=& \eval{\lstinline'\\forall integer i; t_1 <= i < t_2 ==> p'}{sto}&
  \end{tabular}
\end{proof}


\begin{lemma}
  \eval{$t_1 \le id \le t_2$}{sto$_{i_3}$} = 1
\end{lemma}

\begin{proof}
  \begin{tabular}{rclr}
    & \text{Suppose we have the following induction hypothesis H'}: \\
    \eval{$t_1 \le id \le t_2$}{sto'} &= 1 \\
    \eval{$t_1 \le id \le t_2$}{sto$_e$} &= \eval{$t_1 \le id \le t_2$}{sto$_{i_4}$}
    = \eval{$t_1 \le id \le t_2$}{sto'} \\
    \eval{$t_1$}{sto$_{i_5}$} $\le$ \eval{$id$}{sto$_{i_5}$}
    &= \eval{$t_1$}{sto$_{i_4}$} $\le$ \eval{$id$}{sto$_{i_5}$} \\
    &= \eval{$t_1$}{sto$_{i_4}$} $\le$ \eval{$id$}{sto$_{i_4}$} + 1 \\
    &= 1\ \text{due to H'} \\
    \eval{$id$}{sto$_{i_5}$} $\le$ \eval{$t_2$}{sto$_{i_5}$}
    &= \eval{$id$}{sto$_{i_5}$} - 1 < \eval{$t_2$}{sto$_{i_5}$} \\
    &= \eval{$id$}{sto$_{i_4}$} < \eval{$t_2$}{sto$_{i_5}$} \\
    &= \eval{$id$}{sto$_{i_4}$} < \eval{$t_2$}{sto$_{i_4}$} \\
    &= 1\ \text{due to the loop condition} \\
    & \text{So we have \eval{$t_1 \le id \le t_2$}{sto$_{i_5}$} = 1} \\
    & \text{So H' is maintained after each loop iteration} \\
    & \text{So we have \eval{$t_1 \le id \le t_2$}{sto$_{i_3}$} = 1}
  \end{tabular}
\end{proof}



\section{Annotation translation}
\label{sec:annotation-translation}
